\documentclass{article}

\usepackage{amsmath, amssymb}
\usepackage{tikz}
%\usepackage[margin=1.2in]{geometry}

\newcommand{\pder}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\pdbder}[2]{\frac{\partial^2 #1}{\partial #2^2}}

\title{
	Loss function for a Poisson 2D inverse problem \\
	of finding a constant unknown forcing
	}

\author{Rajarshi Dasgupta}

\begin{document}

\maketitle

\section{The Problem}

Find the function $u: \Omega \rightarrow \mathbb{R}$
and constant $f$ such that
\begin{align*}
	& - \nabla^2 u(x,y) = f & \mbox{ for } (x,y) \mbox{ in } \Omega \\
	& u(x,y) = 0.3(1 - x^2 - y^2) & \mbox{ for } (x,y) \mbox{ on } \partial \Omega \\
	& u(x_d,y_d) = 0.3(1 - x_d^2 - y_d^2)
\end{align*}
where $\Omega = (-1,1) \times (-1,1)$
and $(x_d,y_d)$ is an internal data point in $\Omega$.
The solution for this problem is
\begin{align*}
	u & = 0.3(1 - x^2 - y^2) \\
	f &= 1.2
\end{align*}
We wish to solve this class of inverse problems
in the FEM framework using ML techniques.

\section{The loss function}

We will be working with a 3 node triangular mesh
over the domain $\Omega$.
The input for the loss function would be
\begin{enumerate}
	\item the vector $u_{\mathit{out}}$
		where the indices are the value of $u$ at each node,
		which would be the output of a GCN,
	\item $f_{\mathit{val}}$, a guess for the unknown constant $f$,
		which would be a trainable parameter,
	\item the stiffness matrix $K \in \mathbb{R}^{n \times n}$,
	\item data forcing vector $f_d \in \mathbb{R}^n$,
	\item and forcing vector $f_0 \in \mathbb{R}^n$
		assuming a forcing of unity,
		that is $f=1$.
\end{enumerate}
where $n$ is the degree of freedom,
that is the number of nodes
on which the value of $u$ is unknown.
If we have $N \times N$ total nodes,
$n = N^2 - 4N + 3$,
as there are $4(N-2) + 4$ boundary data points
and 1 internal data point.

The loss function we consider is the following.
\begin{align}
	r &= K u_{\mathit{out}} + f_d - f_{\mathit{val}} f_0 \\
	\mathit{Loss} &= \sum_i r_i^2 \label{loss}
\end{align}
The derivation can be found in the following sections.

\section{Algebraic equations for one element}

\begin{figure}
\centering
\begin{tikzpicture}[scale=0.8]
  \draw (-1,-1) -- (5,-1) -- (5,5) -- (-1,5) -- (-1,-1) ;
  \draw (1,3) node[left] {$V_1$} -- (3,2) node[below] {$V_2$} -- (4,4) node[right] {$V_3$} -- (1,3) ;
  \draw[->] (0,0) -- (1,0) node[right] {$x$} ;
  \draw[->] (0,0) -- (0,1) node[above] {$y$} ;
\end{tikzpicture}
\begin{tikzpicture}[scale=0.8]
  \draw (-1,-1) -- (5,-1) -- (5,5) -- (-1,5) -- (-1,-1) ;
  \draw (3,1) node[right] {$V'_1(1,0)$} -- (1,3) node[above] {$V'_2(0,1)$} -- (1,1) node[below] {$V'_3(0,0)$} -- (3,1) ;
  \draw[->] (0,0) -- (1,0) node[right] {$\xi$} ;
  \draw[->] (0,0) -- (0,1) node[above] {$\eta$} ;
\end{tikzpicture}
\caption{
  The triangular element $T$ in the computaional domain
  is shown on the left
  while its reference element $T'$ 
  is shown on the right.
  }
\label{elems}
\end{figure}

\begin{figure}
\centering
\begin{tikzpicture}[scale=1.8]
  \draw (1,3) node[left] {$V_1$} -- (3,2) node[below] {$V_2$} -- (4,4) node[right] {$V_3$} -- (1,3) ;
  \draw (8/3,3) node[above] {$O$} -- (1,3) ;
  \draw (8/3,3) -- (3,2) ;
  \draw (8/3,3) -- (4,4) ;
  \draw[->] (0,0) -- (1,0) node[right] {$x$} ;
  \draw[->] (0,0) -- (0,1) node[above] {$y$} ;
\end{tikzpicture}
\caption{
  To define parameters $\xi$ and $\eta$
  we form three triangles
  $OV_2V_3$, $OV_3V_1$, and $OV_1V_2$
  which put together form the triangle $V_1V_2V_3$.
  }
\label{bary}
\end{figure}

Consider the triangular element $T$
as seen in figure \ref{elems}.
Given a point $O(x,y)$ inside the triangle $V_1V_2V_3$,
we define $\xi$ and $\eta$,
the barycentric coordinates.
\begin{align*}
  \xi &= \frac{\text{area}(OV_2V_3)}{\text{area}(V_1V_2V_3)} \\
  \eta &= \frac{\text{area}(OV_1V_3)}{\text{area}(V_1V_2V_3)} \\
\end{align*}
Let the value of the trial function $u(x,y)$
at the vertices $V_1$, $V_2$ and $V_3$
be $u_1$, $u_2$ and $u_3$ respectively.
Similarly,
let the value of the test function $v(x,y)$
at the vertices $V_1$, $V_2$ and $V_3$
be $v_1$, $v_2$ and $v_3$ respectively.
Now, the points inside or on the triangle
are easily parameterised by $\xi$ and $\eta$
in the following manner.
\begin{align}
  x &= N_1 x_1 + N_2 x_2 + N_3 x_3 \label{x}\\
  y &= N_1 y_1 + N_2 y_2 + N_3 y_3 \label{y}
\end{align}
where
\begin{align*}
	N = \begin{bmatrix} N_1 & N_2 & N_3 \end{bmatrix} \\
	N_1, N_2, N_3 = \xi, \eta, 1 - \xi - \eta
\end{align*}

Assuming $V_1$, $V_2$ and $V_3$ to be free nodes,
the finite dimensional weak formulation
for the Poisson's problem in two dimensions
for the triangular element $T$
is to find $\hat{u} = \begin{bmatrix} u_1 & u_2 & u_3 \end{bmatrix}^{\mathsf{T}}$
such that
\begin{align}
	\int_T \pder{v}{x}\pder{u}{x} + \pder{v}{y}\pder{u}{y} dxdy = \int_T fv dxdy \label{weak}
\end{align}
for all $\hat{v} = \begin{bmatrix} v_1 & v_2 & v_3 \end{bmatrix}^{\mathsf{T}}$,
where,
\begin{align*}
	& u(x(\xi,\eta), y(\xi,\eta)) = N \hat{u} \\
	& v(x(\xi,\eta), y(\xi,\eta)) = N \hat{v} \\
\end{align*}
Following standard procedure,
to find algebraic equations for the element,
we start from
\begin{align*}
	\begin{bmatrix} {\partial u}/{\partial \xi} \\ {\partial u}/{\partial \eta} \end{bmatrix}
		& = J \begin{bmatrix} {\partial u}/{\partial x} \\ {\partial u}/{\partial y} \end{bmatrix} 
			& J = \begin{bmatrix} x_1 - x_3 & y_1 - y_3 \\ x_2 - x_3 & y_2 - y_3 \end{bmatrix} \\
	\implies \begin{bmatrix} {\partial u}/{\partial x} \\ {\partial u}/{\partial y} \end{bmatrix}
		& = J^{-1} \begin{bmatrix} {\partial u}/{\partial \xi} \\ {\partial u}/{\partial \eta} \end{bmatrix} \\
		& = J^{-1} \begin{bmatrix} u_1 - u_3 \\ u_2 - u_3 \end{bmatrix}
\end{align*}
Therefore,
\begin{align}
	\begin{bmatrix} {\partial u}/{\partial x} \\ {\partial u}/{\partial y} \end{bmatrix}
		&= B \hat{u} \label{ugrad} \\ 
	\begin{bmatrix} {\partial v}/{\partial x} \\ {\partial v}/{\partial y} \end{bmatrix}
		&= B \hat{v} \label{vgrad} \\ 
\end{align}
where,
\begin{align*}
	B = \frac{1}{\det J} 
	\begin{bmatrix} y_2 - y_3 & y_3 - y_1 \\ x_3 - x_2 & x_1 - x_3 \end{bmatrix}
	\begin{bmatrix} 1 & 0 & -1 \\ 0 & 1 & -1 \end{bmatrix}
\end{align*}
So, the LHS of equation \ref{weak} is the following.
\begin{align*}
	& \int_T (B\hat{v})^{\mathsf{T}} (B\hat{u}) dxdy \\
	=& \hat{v}^{\mathsf{T}} B^{\mathsf{T}}B \hat{u} \int_T dxdy \\
	=& \hat{v}^{\mathsf{T}} K_e \hat{u}
\end{align*}
where,
\begin{align*}
	K_e = \frac{\det J}{2} B^{\mathsf{T}}B
\end{align*}
The RHS of equation \ref{weak} is the following.
\begin{align*}
	& \int_T f \hat{v}^{\mathsf{T}} \begin{bmatrix} N_1 \\ N_2 \\ N_3 \end{bmatrix} \det J d\xi d\eta \\
		= & f \hat{v}^{\mathsf{T}} \hat{f}_e 
\end{align*}
where $ \hat{f}_e = \det J/6 \begin{bmatrix} 1 & 1 & 1 \end{bmatrix}^{\mathsf{T}}$.

Therefore, under the assumption that
$V_1$, $V_2$ and $V_3$ are free nodes,
the finite dimensional weak form boils down to
finding $\hat{u}$ such that
\begin{align}
	\hat{v}^{\mathsf{T}} K_e \hat{u} = f \hat{v}^{\mathsf{T}} \hat{f}_e
	\label{elem_weak_form}
\end{align}
for all $\hat{v} \in \mathbb{R}^3$.

\section{Assembly}

Upon assembling the equations obtained by the above mentioned treatment,
we get the following larger system of equations to be solved.
\begin{align*}
	\bar{v}^{\mathsf{T}} \bar{K} \bar{u} = f \bar{v}^{\mathsf{T}} \bar{f}
\end{align*}
where,
\begin{enumerate}
	\item the total number of nodes are $N^2$,
	\item $\bar{u} \in \mathbb{R}^{N^2}$
		and $\bar{u}_i$ is the value of $u$ at the $i$-th node,
	\item similarly,
		$\bar{v} \in \mathbb{R}^{N^2}$
		and $\bar{v}_i$ is the value of $v$ at the $i$-th node
	\item $\bar{K} \in \mathbb{R}^{N^2 \times N^2}$ and
		\begin{align*}
			\bar{K}_{ij} = \sum_{\{ i^\prime,j^\prime,e | e(i^\prime) = i \& e(j^\prime) = j \}} K_e(i^\prime, j^\prime)
		\end{align*}
		note that an element $e$ is defined by three node indices,
		so if nodes $i_1$, $i_2$ and $i_3$ form the element $e$,
		$e(k) = i_k$ for $k=$ 1, 2 and 3.
	\item $\bar{f} \in \mathbb{R}^{N^2}$ and its $i$-th entry
		\begin{align*}
			\bar{f}_i = \sum_{\{ i^\prime,e | e(i^\prime) = i\}} \hat{f}_e(i^\prime)
		\end{align*}
\end{enumerate}

We know the value of $u$
on $\partial \Omega$ and the data point on $(x_d,y_d)$.
As discussed earlier there are $n = N^2- 4N + 3$ free nodes
$\mathcal{F} = [i_1, i_2, \dots, i_n]$
and $n^\prime = 4N - 3$ data nodes
$\mathcal{D} = [i_1^\prime, i_2^\prime, \dots, i_{n'}^\prime]$
From the variational form,
the value of the test function on the data nodes is zero
and arbitrary on the free nodes,
therefore,
\begin{align}
	& K \tilde{u} + K^\prime \tilde{u}^\prime = f f_0 \\
	\implies 
	& K \tilde{u} + f_d = f f_0 \label{main_eq}
\end{align}
where,
\begin{enumerate}
	\item the values at the free nodes is $\tilde{u} \in \mathbb{R}^n$,
		the $k$-th entry
		$\tilde{u}_k = \bar{u}_{i_k}$ for $\mathcal{F}(k) = i_k$, the $k$-th free node
	\item the values at the data nodes is $\tilde{u}^\prime \in \mathbb{R}^{n^\prime}$,
		the $k$-th entry
		$\tilde{u}_k^\prime = \bar{u}_{i_k^\prime}$ for $\mathcal{D}(k) = i_k^\prime$, the $k$-th data node
	\item the vector $f_0 \in \mathbb{R}^n$,
		the $k$-th entry is $\bar{f}_{i_k}$ for $\mathcal{F}(k) = i_k$, the $k$-th free node
	\item the matrix $K \in \mathbb{R}^{n \times n}$,
		such that $K_{ij} = \bar{K}_{i' j'}$,
		$i^\prime$ and $j^\prime$ are the $i$-th and $j$-th free nodes,
		that is $\mathcal{F}(i) = i^\prime$
		and $\mathcal{F}(j) = j^\prime$
	\item the matrix $K^\prime \in \mathbb{R}^{n^\prime \times n^\prime}$
		such that $K_{ij}^\prime = \bar{K}_{i' j'}$,
		$i^\prime$ is the $i$-th free node,
		that is $\mathcal{F}(i) = i^\prime$,
		and $j^\prime$ is the $j$-th data node,
		that is $\mathcal{D}(j) = j^\prime$
\end{enumerate}

\section{Justification for the loss}

From equation \ref{main_eq} we form the residual $r$
and use its squared sum as the loss as seen in equation \ref{loss}.
\begin{align*}
	r &= K u_{\mathit{out}} + f_d - f_{\mathit{val}} f_0 \\
	\mathit{Loss} &= \sum_i r_i^2 \label{loss}
\end{align*}

\section{Other alternatives}

\end{document}


